<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analyst Report: Tribe Performance</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --bt-blue: #002D72; --bt-light: #f0f8ff; --text: #333; --border: #ddd; }
        body { font-family: 'Segoe UI', Helvetica, sans-serif; background: #f4f4f4; color: var(--text); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Header & Navigation */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--bt-blue); padding-bottom: 20px; margin-bottom: 30px; }
        h1 { margin: 0; color: var(--bt-blue); font-size: 24px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .tab { padding: 8px 16px; cursor: pointer; border: 1px solid transparent; border-radius: 4px; font-weight: 600; color: #666; }
        .tab.active { background: var(--bt-blue); color: white; border-color: var(--bt-blue); }
        
        /* Upload Box */
        .upload-box { border: 2px dashed var(--bt-blue); background: var(--bt-light); padding: 40px; text-align: center; border-radius: 6px; cursor: pointer; margin-bottom: 20px; }
        .upload-box:hover { background: #e6f2ff; }
        
        /* Report Sections */
        .report-section { display: none; animation: fadeIn 0.5s; }
        .report-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* KPI Cards */
        .kpi-row { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .kpi-card { flex: 1; min-width: 200px; background: #fff; border-left: 5px solid var(--bt-blue); padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 4px; }
        .kpi-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 24px; font-weight: bold; margin: 8px 0; color: #000; }
        .kpi-sub { font-size: 11px; color: #888; }
        
        /* Analysis Text Block */
        .analyst-commentary { background: #fff8e1; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 30px; border-radius: 0 4px 4px 0; }
        .analyst-commentary h4 { margin-top: 0; color: #856404; display: flex; align-items: center; gap: 8px; }
        
        /* Charts & Tables */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .chart-box { border: 1px solid var(--border); padding: 15px; border-radius: 6px; height: 350px; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { background: #f8f9fa; text-align: left; padding: 10px; border-bottom: 2px solid #ddd; }
        .data-table td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        .data-table tr:hover { background: #fcfcfc; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .btn { background: var(--bt-blue); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #001e4d; }
    </style>
</head>
<body>

<div class="container" id="report-container">
    <header>
        <div>
            <h1>Financial Performance Report</h1>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">Period: <span id="period-display">Waiting for Data...</span></div>
        </div>
        <button class="btn hidden" id="pdf-btn" onclick="exportPDF()">Download PDF Report</button>
    </header>

    <div id="upload-section">
        <div class="upload-box" id="drop-zone">
            <h3>ðŸ“‚ Upload "MSL Cumulative Billing"</h3>
            <p>Drag & drop your Excel file here to generate the Analyst Report</p>
            <input type="file" id="file-input" accept=".xlsx" style="display:none">
        </div>
        <div id="error-msg" style="color: red; text-align: center; margin-top: 10px;"></div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="tabs" id="nav-tabs">
            </div>

        <div id="report-content"></div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const TABS_CONFIG = [
        { id: "all", label: "Group Executive Summary", isAgg: true },
        { id: "oneconsumer", label: "One Consumer", keys: ["One Consumer"], sheetMatch: "One Consumer" },
        { id: "home", label: "Home", keys: ["Home"], sheetMatch: "Home" },
        { id: "mobile", label: "Mobile", keys: ["Mobile"], sheetMatch: "Mobile" },
        { id: "migrations", label: "Migrations", keys: ["Migrations"], sheetMatch: "Migrations" }
    ];
    
    // Standard Periods
    const PERIODS = ["P1 - April", "P2 - May", "P3 - June", "P4 - July", "P5 - August", "P6 - September", "P7 - October", "P8 - November", "P9 - December", "P10 - January", "P11 - February", "P12 - March"];
    const SHORT_PERIODS = ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"];

    // --- STATE ---
    let GLOBAL_DATA = {};
    let CURRENT_PX_INDEX = 0;

    // --- INITIALIZATION ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#e6f2ff'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.background = '#f0f8ff'; });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

    // --- MAIN PROCESSOR ---
    function handleFile(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(e.target.result, {type: 'array'});
                processWorkbook(workbook);
            } catch (err) {
                alert("Error reading file. Ensure it is a valid Excel file.");
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function processWorkbook(workbook) {
        GLOBAL_DATA = {}; // Reset
        let globalRollup = new Array(12).fill(0);
        let maxMonthIdx = -1;

        // 1. Parse Each Tribe Tab
        TABS_CONFIG.forEach(tab => {
            if(tab.isAgg) return;
            
            // Fuzzy match sheet name (e.g., "One Consumer (Against Mark)")
            const sheetName = workbook.SheetNames.find(s => s.toLowerCase().includes(tab.sheetMatch.toLowerCase()) && s.toLowerCase().includes("mark"));
            
            const tabData = {
                name: tab.label,
                monthlyTotal: new Array(12).fill(0),
                expmoBreakdown: {}, // { "EXPMO_CODE": TotalYTD }
                rows: []
            };

            if (sheetName) {
                const ws = workbook.Sheets[sheetName];
                const raw = XLSX.utils.sheet_to_json(ws, {header: 1});
                
                // Find Header (Look for "EXPMO" or "P1")
                const headerRowIdx = raw.findIndex(r => r && r.some(c => (c||"").toString().toUpperCase() === "EXPMO" || (c||"").toString().includes("P1 ")));
                
                if (headerRowIdx > -1) {
                    const headers = raw[headerRowIdx].map(h => (h||"").toString().trim());
                    // Find Column Indices
                    const expmoIdx = headers.findIndex(h => h.toUpperCase().includes("EXPMO"));
                    const pIndices = PERIODS.map(p => headers.findIndex(h => h.toLowerCase().startsWith(p.split(" -")[0].toLowerCase())));

                    // Process Rows
                    const dataRows = raw.slice(headerRowIdx + 1);
                    dataRows.forEach(row => {
                        // EXPMO Code
                        let expmo = expmoIdx > -1 ? (row[expmoIdx] || "Unassigned") : "Unassigned";
                        if(expmo === 0 || expmo === "0") expmo = "Unassigned";

                        let rowSum = 0;
                        pIndices.forEach((colIdx, i) => {
                            if(colIdx > -1) {
                                let val = parseFloat(row[colIdx]) || 0;
                                tabData.monthlyTotal[i] += val;
                                globalRollup[i] += val;
                                rowSum += val;
                                
                                if(Math.abs(val) > 1) maxMonthIdx = Math.max(maxMonthIdx, i);
                            }
                        });

                        // Add to EXPMO Tally (only if row has spend)
                        if(Math.abs(rowSum) > 0.01) {
                            tabData.expmoBreakdown[expmo] = (tabData.expmoBreakdown[expmo] || 0) + rowSum;
                        }
                    });
                }
            }
            GLOBAL_DATA[tab.id] = tabData;
        });

        // 2. Set Aggregated Data (Executive Summary)
        const allExpmo = {};
        Object.values(GLOBAL_DATA).forEach(d => {
            Object.entries(d.expmoBreakdown || {}).forEach(([k,v]) => {
                allExpmo[k] = (allExpmo[k] || 0) + v;
            });
        });

        GLOBAL_DATA["all"] = {
            name: "Total Portfolio",
            monthlyTotal: globalRollup,
            expmoBreakdown: allExpmo
        };

        // 3. Set Current Period
        CURRENT_PX_INDEX = (maxMonthIdx === -1) ? 0 : maxMonthIdx;
        document.getElementById("period-display").innerText = `${PERIODS[CURRENT_PX_INDEX]}`;
        
        // 4. Render Interface
        renderDashboard();
    }

    function renderDashboard() {
        document.getElementById("upload-section").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("pdf-btn").classList.remove("hidden");

        const nav = document.getElementById("nav-tabs");
        const content = document.getElementById("report-content");
        nav.innerHTML = "";
        content.innerHTML = "";

        TABS_CONFIG.forEach((tab, index) => {
            // Create Tab
            const btn = document.createElement("div");
            btn.className = `tab ${index === 0 ? 'active' : ''}`;
            btn.innerText = tab.label;
            btn.onclick = () => switchTab(tab.id, btn);
            nav.appendChild(btn);

            // Create Section (Hidden by default except first)
            const section = document.createElement("div");
            section.id = `view-${tab.id}`;
            section.className = `report-section ${index === 0 ? 'active' : ''}`;
            section.innerHTML = generateSectionHTML(tab.id);
            content.appendChild(section);

            // Render Charts for this section
            renderCharts(tab.id);
        });
    }

    function switchTab(id, btnEl) {
        // Update Tabs
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        btnEl.classList.add("active");
        
        // Update Views
        document.querySelectorAll(".report-section").forEach(s => s.classList.remove("active"));
        document.getElementById(`view-${id}`).classList.add("active");
    }

    function generateSectionHTML(id) {
        const data = GLOBAL_DATA[id];
        const ytd = data.monthlyTotal.slice(0, CURRENT_PX_INDEX + 1).reduce((a,b)=>a+b,0);
        
        // Analysis Logic
        const topExpmo = Object.entries(data.expmoBreakdown)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5); // Top 5
        
        const topExpmoName = topExpmo.length ? topExpmo[0][0] : "N/A";
        const topExpmoVal = topExpmo.length ? topExpmo[0][1] : 0;

        // Analyst Commentary Generator
        const commentary = `
            <h4>ðŸ’¡ Analyst Insights</h4>
            <p>
                <strong>YTD Performance:</strong> ${data.name} has recorded a total spend of <strong>Â£${ytd.toLocaleString('en-GB', {maximumFractionDigits:0})}</strong> through ${SHORT_PERIODS[CURRENT_PX_INDEX]}.
                <br><br>
                <strong>Driver Analysis:</strong> The primary cost driver is EXPMO code <strong>${topExpmoName}</strong>, accounting for Â£${topExpmoVal.toLocaleString('en-GB', {maximumFractionDigits:0})} 
                (${(ytd? (topExpmoVal/ytd)*100 : 0).toFixed(1)}% of total).
                <br><br>
                <strong>Trend:</strong> Spend in the current month (${SHORT_PERIODS[CURRENT_PX_INDEX]}) was Â£${data.monthlyTotal[CURRENT_PX_INDEX].toLocaleString()}.
            </p>
        `;

        return `
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">YTD Actuals</div>
                    <div class="kpi-value">Â£${ytd.toLocaleString('en-GB', {minimumFractionDigits: 0})}</div>
                    <div class="kpi-sub">April - ${SHORT_PERIODS[CURRENT_PX_INDEX]}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Current Month (${SHORT_PERIODS[CURRENT_PX_INDEX]})</div>
                    <div class="kpi-value">Â£${data.monthlyTotal[CURRENT_PX_INDEX].toLocaleString('en-GB', {minimumFractionDigits: 0})}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Top EXPMO Driver</div>
                    <div class="kpi-value" style="font-size:18px">${topExpmoName}</div>
                    <div class="kpi-sub">Â£${topExpmoVal.toLocaleString('en-GB', {maximumFractionDigits:0})}</div>
                </div>
            </div>

            <div class="analyst-commentary">${commentary}</div>

            <div class="chart-grid">
                <div class="chart-box">
                    <canvas id="chart-trend-${id}"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="chart-expmo-${id}"></canvas>
                </div>
            </div>

            <h3>EXPMO Code Breakdown (Top 5)</h3>
            <table class="data-table">
                <thead><tr><th>EXPMO Code</th><th>YTD Spend</th><th>% of Total</th></tr></thead>
                <tbody>
                    ${topExpmo.map(([code, val]) => `
                        <tr>
                            <td>${code}</td>
                            <td>Â£${val.toLocaleString('en-GB', {minimumFractionDigits: 2})}</td>
                            <td>${(ytd ? (val/ytd)*100 : 0).toFixed(1)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function renderCharts(id) {
        const data = GLOBAL_DATA[id];
        const ctxTrend = document.getElementById(`chart-trend-${id}`);
        const ctxExpmo = document.getElementById(`chart-expmo-${id}`);
        
        // 1. Trend Line Chart
        new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: SHORT_PERIODS.slice(0, CURRENT_PX_INDEX + 1),
                datasets: [{
                    label: 'Monthly Actuals',
                    data: data.monthlyTotal.slice(0, CURRENT_PX_INDEX + 1),
                    borderColor: '#002D72',
                    backgroundColor: 'rgba(0, 45, 114, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { title: { display: true, text: 'Monthly Spend Trend' }, legend: {display: false} }
            }
        });

        // 2. EXPMO Bar Chart (Top 5)
        const sortedExpmo = Object.entries(data.expmoBreakdown).sort(([,a], [,b]) => b - a).slice(0, 5);
        new Chart(ctxExpmo, {
            type: 'bar',
            data: {
                labels: sortedExpmo.map(x => x[0]),
                datasets: [{
                    label: 'YTD Spend',
                    data: sortedExpmo.map(x => x[1]),
                    backgroundColor: ['#002D72', '#005EB8', '#0078D4', '#50E6FF', '#E6F2FF']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { title: { display: true, text: 'Top 5 Cost Drivers (EXPMO)' }, legend: {display: false} }
            }
        });
    }

    function exportPDF() {
        const element = document.getElementById('report-container');
        const opt = {
            margin: 10,
            filename: `Finance_Report_${PERIODS[CURRENT_PX_INDEX]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        // Temporarily show all sections for print
        document.querySelectorAll('.report-section').forEach(s => s.style.display = 'block');
        document.querySelector('.tabs').style.display = 'none'; // Hide tabs for print
        
        html2pdf().set(opt).from(element).save().then(() => {
            // Revert UI
            document.querySelectorAll('.report-section').forEach(s => s.style.display = '');
            document.querySelector('.active').style.display = 'block';
            document.querySelector('.tabs').style.display = 'flex';
        });
    }
</script>

</body>
</html>
